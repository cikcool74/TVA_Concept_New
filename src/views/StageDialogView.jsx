import { useEffect, useRef, useState } from "react";
import { ArrowLeft, MessageSquare, SkipForward } from "lucide-react";
import { PixelCard } from "../components/PixelCard";

const STAGE_CONTENT = {
  1: {
    title: "–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ. –ö–∞–∫ —Å–ª—É—à–∞—Ç—å –º—É–¥—Ä–µ—Ü–∞",
    lines: [
      "–ü—É—Ç–Ω–∏–∫, –º—ã —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ–º –ø—É—Ç—å. –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –ø—è—Ç—å —à–∞–≥–æ–≤ —É—Ä–æ–∫–∞.\n\n–î–∏–∞–ª–æ–≥ —Å –º—É–¥—Ä–µ—Ü–æ–º ‚Äî –ø–µ—Ä–≤—ã–π. –û–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–µ–±—è, —á—Ç–æ–±—ã —Ç—ã –Ω–µ –Ω–∞–∂–∏–º–∞–ª –∫–Ω–æ–ø–∫–∏ –º–∞—à–∏–Ω–∞–ª—å–Ω–æ.",
      "–ó–∞–¥–∞–π —Å–µ–±–µ –≤–æ–ø—Ä–æ—Å: –∫–∞–∫—É—é —Ü–µ–ª—å —Ç—ã —Ö–æ—á–µ—à—å –¥–æ—Å—Ç–∏—á—å?\n\n–ó–∞–ø–∏—à–∏ –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ, –¥–∞–∂–µ –≤ –º—ã—Å–ª—è—Ö ‚Äî —Ç–∞–∫ –º–æ–∑–≥ –ø–æ–π–º–µ—Ç, –∑–∞—á–µ–º –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ.",
      "–ï—Å–ª–∏ –ø–æ—á—É–≤—Å—Ç–≤—É–µ—à—å —Å–ø–µ—à–∫—É ‚Äî –∑–∞–º–µ–¥–ª–∏—Å—å. –ö–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º.",
      "–ö–æ–≥–¥–∞ –±—É–¥–µ—à—å –≥–æ—Ç–æ–≤, –Ω–∞–∂–º–∏ ¬´–î–∞–ª–µ–µ¬ª. –≠—Ç–æ –æ—Ç–º–µ—Ç–∏—Ç —ç—Ç–∞–ø –∫–∞–∫ –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–π –∏ –æ—Ç–∫—Ä–æ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.",
      "–ü–æ–º–Ω–∏: —Ç—ã —Å–∞–º –≤—ã–±–∏—Ä–∞–µ—à—å —Ç–µ–º–ø. –Ø –ª–∏—à—å –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é –ø—É—Ç—å. –í—Å—Ç—Ä–µ—Ç–∏–º—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –±–ª–æ–∫–µ —É—Ä–æ–∫–∞.",
    ],
  },
  2: {
    title: "–ß—Ç–æ —Ç–∞–∫–æ–µ —Ä—ã–Ω–æ–∫",
    lines: [
      "üîπ –ü—Ä–µ–¥—Å—Ç–∞–≤—å –æ–±—ã—á–Ω—ã–π —Ä—ã–Ω–æ–∫. –¢—ã –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –≤–∏–¥–µ–ª –±–∞–∑–∞—Ä –∏–ª–∏ —Ç–æ—Ä–≥–æ–≤—É—é –ø–ª–æ—â–∞–¥—å. –õ—é–¥–∏ —Ç–∞–º: –ø—Ä–æ–¥–∞—é—Ç, –ø–æ–∫—É–ø–∞—é—Ç, –æ–±–º–µ–Ω–∏–≤–∞—é—Ç. –ö—Ç–æ-—Ç–æ –ø—Ä–æ–¥–∞—ë—Ç —è–±–ª–æ–∫–∏, –∫—Ç–æ-—Ç–æ –∏–≥—Ä—É—à–∫–∏, –∫—Ç–æ-—Ç–æ —Ö–ª–µ–±. –ö–∞–∂–¥—ã–π —Ö–æ—á–µ—Ç –Ω–∞–π—Ç–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.",
      "üîπ –¢–µ–ø–µ—Ä—å –ø—Ä–µ–¥—Å—Ç–∞–≤—å —ç—Ç–æ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –í–æ—Ç —Ç–∞–∫ –∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Ä—ã–Ω–æ–∫. –¢–æ–ª—å–∫–æ –≤–º–µ—Å—Ç–æ —è–±–ª–æ–∫ –ª—é–¥–∏ –ø–æ–∫—É–ø–∞—é—Ç –¥–æ–ª–ª–∞—Ä—ã, –±–∏—Ç–∫–æ–∏–Ω, –∞–∫—Ü–∏–∏, –∑–æ–ª–æ—Ç–æ. –ò –≤—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ –Ω–∞ –ø–ª–æ—â–∞–¥–∏, –∞ –Ω–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ, —á–µ—Ä–µ–∑ –∫–æ–º–ø—å—é—Ç–µ—Ä –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω.",
      "üîπ –ö—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å ‚Üí –∑–∞—è–≤–∫–∞, –∫—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç –ø—Ä–æ–¥–∞—Ç—å ‚Üí –∑–∞—è–≤–∫–∞. –°–∏—Å—Ç–µ–º–∞ —Å–æ–µ–¥–∏–Ω—è–µ—Ç —ç—Ç–∏ –∑–∞—è–≤–∫–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π. –≠—Ç–æ –∫–∞–∫ –µ—Å–ª–∏ –±—ã —Å—É–ø–µ—Ä-–±—ã—Å—Ç—Ä—ã–π –Ω–µ–≤–∏–¥–∏–º—ã–π –ø–æ–º–æ—â–Ω–∏–∫ —Å—Ç–æ—è–ª –ø–æ—Å—Ä–µ–¥–∏ –±–∞–∑–∞—Ä–∞ –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–æ–µ–¥–∏–Ω—è–ª –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è —Å –ø—Ä–æ–¥–∞–≤—Ü–æ–º.\n üî• –í–∞–∂–Ω–æ: –†—ã–Ω–æ–∫ - —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –ª—é–¥–∏ –æ–±–º–µ–Ω–∏–≤–∞—é—Ç—Å—è —Ü–µ–Ω–Ω–æ—Å—Ç—è–º–∏.",
      "üîπ –†—ã–Ω–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –∂–µ–ª–∞–Ω–∏—è –ª—é–¥–µ–π —Ä–∞–∑–Ω—ã–µ: –∫—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å, –∫—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç –ø—Ä–æ–¥–∞—Ç—å, –∫—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å –º–Ω–æ–≥–æ, –∫—Ç–æ-—Ç–æ - –º–∞–ª–æ, –∫—Ç–æ-—Ç–æ - –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, –∫—Ç–æ-—Ç–æ - –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏—Ç—Å—è. –ò —Ä—ã–Ω–æ–∫ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–º –≤—Å–µ–º –Ω–∞—Ö–æ–¥–∏—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞.",
      "üëÄ –ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –≤ —Ç—Ä–µ–π–¥–∏–Ω–≥–µ. –í —Ç—Ä–µ–π–¥–∏–Ω–≥–µ —Ä—ã–Ω–æ–∫ - —ç—Ç–æ –æ–≥—Ä–æ–º–Ω–∞—è –≥—Ä—É–ø–ø–∞ –ª—é–¥–µ–π –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É, –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∫ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–∫—É–ø–∞—é—Ç –∏ –ø—Ä–æ–¥–∞—é—Ç. –≠—Ç–∞ —Å–∏—Å—Ç–µ–º–∞ –∏ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ä—ã–Ω–∫–æ–º.",
      "üß† –†—ã–Ω–æ–∫ ‚Äî —ç—Ç–æ –Ω–µ –∑–¥–∞–Ω–∏–µ –∏ –Ω–µ –º–µ—Å—Ç–æ. –≠—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –æ–±–º–µ–Ω–∞ –º–µ–∂–¥—É –ª—é–¥—å–º–∏. –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –∏ –æ–¥–∏–Ω –ø—Ä–æ–¥–∞–≤–µ—Ü ‚Äî —Ä—ã–Ω–æ–∫ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.",
    ],
  },
  3: {
    title: "–ú–∏–Ω–∏-–∏–≥—Ä—ã –æ —Ä—ã–Ω–∫–µ",
    lines: [
      "–ú–∏–Ω–∏-–∏–≥—Ä–∞ 1 ‚Äî ¬´–°–æ–±–µ—Ä–∏ —Ä—ã–Ω–æ–∫¬ª. –ò–≥—Ä–æ–∫—É –¥–∞—é—Ç 4 –ø—Ä–µ–¥–º–µ—Ç–∞: –ø–æ–∫—É–ø–∞—Ç–µ–ª—å, –ø—Ä–æ–¥–∞–≤–µ—Ü, –∞–∫—Ç–∏–≤ (—è–±–ª–æ–∫–æ –∏–ª–∏ BTC), —Ü–µ–Ω–∞. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø–æ—Ä—è–¥–æ–∫: –ü–æ–∫—É–ø–∞—Ç–µ–ª—å ‚Üí –¶–µ–Ω–∞ ‚Üí –ê–∫—Ç–∏–≤ ‚Üí –ü—Ä–æ–¥–∞–≤–µ—Ü. –ü–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ñ—Ä–∞–∑–∞: ¬´–≠—Ç–æ –∏ –µ—Å—Ç—å —Ä—ã–Ω–æ–∫!¬ª",
      "–ú–∏–Ω–∏-–∏–≥—Ä–∞ 2 ‚Äî ¬´–ñ–∏–≤–æ–π —Ä—ã–Ω–æ–∫¬ª. –ù–∞ —ç–∫—Ä–∞–Ω–µ 10 —Å–µ–∫—É–Ω–¥ –±–µ–≥–∞—é—Ç –∑–µ–ª—ë–Ω—ã–µ —Ç–æ—á–∫–∏ (–ø–æ–∫—É–ø–∞—Ç–µ–ª–∏) –∏ –∫—Ä–∞—Å–Ω—ã–µ —Ç–æ—á–∫–∏ (–ø—Ä–æ–¥–∞–≤—Ü—ã). –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –¥–≤–µ —Ç–æ—á–∫–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å ‚Üí –≤—Å–ø—ã—à–∫–∞ ¬´–°–¥–µ–ª–∫–∞!¬ª. –ò–≥—Ä–æ–∫ –Ω–∞–±–ª—é–¥–∞–µ—Ç –∏ –ø–æ–Ω–∏–º–∞–µ—Ç: —Ä—ã–Ω–æ–∫ = –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–¥–µ–ª–æ–∫.",
    ],
  },
};

const USER_REPLIES = [
  "–ü–æ–Ω—è–ª, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º.",
  "–ü—Ä–∏–Ω—è—Ç–æ, –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ.",
  "–°–æ–≥–ª–∞—Å–µ–Ω, —Ñ–∏–∫—Å–∏—Ä—É—é.",
  "–û—Å–æ–∑–Ω–∞–ª, –≥–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.",
  "–î–∞, –∏–¥—ë–º –¥–∞–ª—å—à–µ.",
  "–ó–∞–ø–æ–º–Ω–∏–ª, –ø—Ä–æ–¥–æ–ª–∂–∏–º.",
];

export function StageDialogView({ lesson, subLesson, stageId = 1, onFinish, onBack }) {
  const content =
    STAGE_CONTENT[stageId] || { title: "–î–∏–∞–ª–æ–≥", lines: ["–ù–∞—Å—Ç–∞–≤–Ω–∏–∫ –º–æ–ª—á–∏—Ç, –Ω–æ –ø—É—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è."] };
  const [index, setIndex] = useState(0);
  const [history, setHistory] = useState(
    content.lines.length ? [{ speaker: "sage", text: content.lines[0] }] : []
  );
  const scrollRef = useRef(null);

  useEffect(() => {
    const firstLine = content.lines[0];
    setIndex(0);
    setHistory(firstLine ? [{ speaker: "sage", text: firstLine }] : []);
  }, [stageId, subLesson?.id, lesson?.id, content.lines]);

  useEffect(() => {
    const box = scrollRef.current;
    if (box) {
      box.scrollTo({ top: box.scrollHeight, behavior: "smooth" });
    }
  }, [history]);

  const next = () => {
    const nextIndex = index + 1;
    if (nextIndex >= content.lines.length) {
      onFinish?.();
      return;
    }
    const nextLine = content.lines[nextIndex];
    const userReply = USER_REPLIES[nextIndex % USER_REPLIES.length];
    setHistory((prev) => [
      ...prev,
      { speaker: "user", text: userReply },
      { speaker: "sage", text: nextLine },
    ]);
    setIndex(nextIndex);
  };

  const subtitle = subLesson?.title || lesson?.title || "–£—Ä–æ–∫";

  return (
    <div className="space-y-4">
      <button onClick={onBack} className="text-xs text-gray-400 hover:text-white flex items-center gap-1">
        <ArrowLeft size={12} /> –ù–∞–∑–∞–¥
      </button>

      <PixelCard className="bg-[#0f1724] border-[#1f2937]">
        <div className="flex items-center gap-2 mb-3">
          <MessageSquare size={16} className="text-amber-300" />
          <div className="text-sm font-bold text-white">
            –î–∏–∞–ª–æ–≥: {subtitle} ‚Äî {content.title}
          </div>
        </div>
        <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-1" ref={scrollRef}>
          {history.map((entry, idx) => (
            <div key={idx} className={`flex ${entry.speaker === "sage" ? "justify-start" : "justify-end"}`}>
              <div
                className={`max-w-[90%] rounded-lg px-3 py-2 text-sm ${
                  entry.speaker === "sage"
                    ? "bg-[#111827] border border-[#1f2937] text-gray-100"
                    : "bg-amber-500/20 border border-amber-400/40 text-amber-100"
                }`}
              >
                <div className="text-[11px] uppercase tracking-widest text-gray-400 mb-1">
                  {entry.speaker === "sage" ? "–ú—É–¥—Ä–µ—Ü" : "–¢—ã"}
                </div>
                <div className="leading-relaxed whitespace-pre-line">{entry.text}</div>
              </div>
            </div>
          ))}
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <button
            className="px-3 py-2 text-xs rounded border border-amber-500 text-amber-200 hover:bg-amber-500/10 flex items-center gap-1"
            onClick={next}
            disabled={!history.length}
          >
            <SkipForward size={14} /> –î–∞–ª–µ–µ
          </button>
          <button
            className="px-3 py-2 text-xs rounded border border-gray-600 text-gray-300 hover:bg-gray-700/40"
            onClick={onBack}
          >
            –ó–∞–∫—Ä—ã—Ç—å
          </button>
        </div>
      </PixelCard>
    </div>
  );
}
